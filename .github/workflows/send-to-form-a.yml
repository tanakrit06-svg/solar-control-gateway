name: log-to-google-form

on:
  repository_dispatch:
    types: [log_event]  # ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö event_type ‡∏ó‡∏µ‡πà ESP32 ‡∏™‡πà‡∏á‡∏°‡∏≤

jobs:
  log_event:
    runs-on: ubuntu-latest
    steps:
      # Debug step - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
      - name: Debug Received Payload
        run: |
          echo "================================"
          echo "Received SOC: ${{ github.event.client_payload.soc }}"
          echo "Received Event: ${{ github.event.client_payload.event_type }}"
          echo "================================"

      # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Form
      - name: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ESP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Form
        run: |
          curl -X POST https://docs.google.com/forms/d/e/1FAIpQLSdrDVFEEkkdZ6k4rdG4OCkTWoek9GBk1Uip-GWWDZR8HCsXkQ/formResponse \
            -d "entry.747932621=${{ github.event.client_payload.soc }}" \
            -d "entry.1561980421=${{ github.event.client_payload.event_type }}" \
            --fail --silent --show-error

      # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE Notify
      - name: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE Notify
        run: |
          curl -X POST https://notify-api.line.me/api/notify \
            -H "Authorization: Bearer 5G0gVu1dgvli6NxKBfKRd6JPGTbGvyEVPhS3sCx4SKFBAXQ7h+aJq0IkBXkit/nji76Ij9BlTXKTdJIpSnMDaTxtSmCAHMivhJiFNB9JsYn1D3S6B+cQCyASMX/d/z1oplxgWQMR0IfvHA89g1Nf4QdB04t89/1O/w1cDnyilFU=" \
            -F "message=üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å ESPHome\nSOC: ${{ github.event.client_payload.soc }}%\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${{ github.event.client_payload.event_type }}"

      # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      - name: Log Success
        if: success()
        run: echo "‚úÖ Successfully logged SOC=${{ github.event.client_payload.soc }}% with event=${{ github.event.client_payload.event_type }}"

      - name: Log Failure
        if: failure()
        run: echo "‚ùå Failed to log to Google Form or LINE Notify"
