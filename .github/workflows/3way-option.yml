name: 3way-option

on:
  repository_dispatch:
    types: [log_event]

jobs:
  handle_soc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: à¸­à¹ˆà¸²à¸™à¸ªà¸–à¸²à¸™à¸°à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸£à¸“à¸µà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        id: read_state
        env:
          SOC: ${{ github.event.client_payload.soc }}
        run: |
          INIT_REQUIRED="false"
          SOC_CHANGED="true"

          if [ ! -f solar_state.txt ] || [ ! -s solar_state.txt ]; then
            echo "âš ï¸ solar_state.txt à¹„à¸¡à¹ˆà¸žà¸šà¸«à¸£à¸·à¸­à¸§à¹ˆà¸²à¸‡ â†’ à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸–à¸²à¸™à¸°à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸ˆà¸²à¸ SOC=$SOC"
            if [ "$SOC" -le 25 ]; then
              MODE="low_batt"
              SOLAR_ON_SENT="false"
              SOLAR_OFF_SENT="true"
              echo "à¸ªà¹ˆà¸‡ solar_off à¹„à¸› Sheet 3 (SOC=$SOC â‰¤ 25)"
              curl -X POST "https://docs.google.com/forms/d/e/1FAIpQLSfR4GihZk5nhFnJndejNVNji_5Mywbg3PIgZi3m3ZjQxGApQQ/formResponse" \
                -d "entry.1012650439=solar_off" \
                --fail --silent --show-error
              echo "âœ… Sheet 3: solar_off sent"
            else
              MODE="normal"
              SOLAR_ON_SENT="true"
              SOLAR_OFF_SENT="false"
              echo "à¸ªà¹ˆà¸‡ solar_on à¹„à¸› Sheet 2 (SOC=$SOC > 25)"
              curl -X POST "https://docs.google.com/forms/d/e/1FAIpQLSchglVNdUfC_titEV191XeR_uH9NnVYyMMmtuoZmgM0oH3yVg/formResponse" \
                -d "entry.29631913=solar_on" \
                --fail --silent --show-error
              echo "âœ… Sheet 2: solar_on sent"
            fi
            LAST_SOC="$SOC"
            echo "mode=$MODE" > solar_state.txt
            echo "solar_on_sent=$SOLAR_ON_SENT" >> solar_state.txt
            echo "solar_off_sent=$SOLAR_OFF_SENT" >> solar_state.txt
            echo "last_soc=$LAST_SOC" >> solar_state.txt
            INIT_REQUIRED="true"
          fi

          MODE=$(grep '^mode=' solar_state.txt | cut -d '=' -f2 || echo "normal")
          SOLAR_ON_SENT=$(grep '^solar_on_sent=' solar_state.txt | cut -d '=' -f2 || echo "false")
          SOLAR_OFF_SENT=$(grep '^solar_off_sent=' solar_state.txt | cut -d '=' -f2 || echo "false")
          LAST_SOC=$(grep '^last_soc=' solar_state.txt | cut -d '=' -f2 || echo "")

          if [ "$SOC" = "$LAST_SOC" ]; then
            SOC_CHANGED="false"
          fi

          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "solar_on_sent=$SOLAR_ON_SENT" >> $GITHUB_OUTPUT
          echo "solar_off_sent=$SOLAR_OFF_SENT" >> $GITHUB_OUTPUT
          echo "last_soc=$LAST_SOC" >> $GITHUB_OUTPUT
          echo "init_required=$INIT_REQUIRED" >> $GITHUB_OUTPUT
          echo "soc_changed=$SOC_CHANGED" >> $GITHUB_OUTPUT

      - name: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Mode
        id: check_mode
        env:
          SOC: ${{ github.event.client_payload.soc }}
          CURRENT_MODE: ${{ steps.read_state.outputs.mode }}
          SOLAR_ON_SENT: ${{ steps.read_state.outputs.solar_on_sent }}
          SOLAR_OFF_SENT: ${{ steps.read_state.outputs.solar_off_sent }}
          LAST_SOC: ${{ steps.read_state.outputs.last_soc }}
          INIT_REQUIRED: ${{ steps.read_state.outputs.init_required }}
          SOC_CHANGED: ${{ steps.read_state.outputs.soc_changed }}
        run: |
          if [ "$INIT_REQUIRED" = "true" ]; then
            echo "âœ… à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸žà¸£à¸²à¸°à¹€à¸žà¸´à¹ˆà¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸–à¸²à¸™à¸°à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™"
            echo "skip_sheet1=true" >> $GITHUB_OUTPUT
            echo "send_solar_on=false" >> $GITHUB_OUTPUT
            echo "send_solar_off=false" >> $GITHUB_OUTPUT
            echo "event_text=Init" >> $GITHUB_OUTPUT
            echo "mode=$CURRENT_MODE" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$SOC_CHANGED" != "true" ]; then
            echo "âœ… SOC à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ â†’ à¸‚à¹‰à¸²à¸¡à¸—à¸¸à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™"
            echo "skip_sheet1=true" >> $GITHUB_OUTPUT
            echo "send_solar_on=false" >> $GITHUB_OUTPUT
            echo "send_solar_off=false" >> $GITHUB_OUTPUT
            echo "event_text=No_Change" >> $GITHUB_OUTPUT
            echo "mode=$CURRENT_MODE" >> $GITHUB_OUTPUT
            exit 0
          fi

          CURRENT_MODE=${CURRENT_MODE:-normal}
          NEW_MODE=$CURRENT_MODE
          EVENT_TEXT=""
          SEND_SOLAR_ON="false"
          SEND_SOLAR_OFF="false"
          SKIP_SHEET1="false"

          if [ "$CURRENT_MODE" = "normal" ]; then
            if [ "$SOC" -le 25 ]; then
              NEW_MODE="low_batt"
              EVENT_TEXT="Low_Batt"
              SEND_SOLAR_OFF="true"
            else
              EVENT_TEXT="Normal_Batt"
              if [ "$SOLAR_ON_SENT" = "false" ] && [ "$SOC" -ge 35 ]; then
                SEND_SOLAR_ON="true"
              fi
            fi
          elif [ "$CURRENT_MODE" = "low_batt" ]; then
            if [ "$SOC" -ge 35 ]; then
              NEW_MODE="normal"
              EVENT_TEXT="Normal_Batt"
              SEND_SOLAR_ON="true"
            else
              EVENT_TEXT="Low_Batt"
            fi
          else
            NEW_MODE="normal"
            EVENT_TEXT="Normal_Batt"
          fi

          if [ "$SOLAR_ON_SENT" = "false" ] && [ "$NEW_MODE" = "normal" ]; then
            SEND_SOLAR_ON="true"
          fi
          if [ "$SOLAR_OFF_SENT" = "false" ] && [ "$NEW_MODE" = "low_batt" ]; then
            SEND_SOLAR_OFF="true"
          fi

          echo "mode=$NEW_MODE" >> $GITHUB_OUTPUT
          echo "event_text=$EVENT_TEXT" >> $GITHUB_OUTPUT
          echo "send_solar_on=$SEND_SOLAR_ON" >> $GITHUB_OUTPUT
          echo "send_solar_off=$SEND_SOLAR_OFF" >> $GITHUB_OUTPUT
          echo "skip_sheet1=$SKIP_SHEET1" >> $GITHUB_OUTPUT

      - name: à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸› Sheet 1
        if: steps.check_mode.outputs.skip_sheet1 != 'true'
        env:
          SOC: ${{ github.event.client_payload.soc }}
          EVENT: ${{ steps.check_mode.outputs.event_text }}
        run: |
          curl -X POST "https://docs.google.com/forms/d/e/1FAIpQLSdrDVFEEkkdZ6k4rdG4OCkTWoek9GBk1Uip-GWWDZR8HCsXkQ/formResponse" \
            -d "entry.747932621=$SOC" \
            -d "entry.1561980421=$EVENT" \
            --fail --silent --show-error

      - name: à¸ªà¹ˆà¸‡ solar_on à¹„à¸› Sheet 2
        if: steps.check_mode.outputs.send_solar_on == 'true'
        run: |
          curl -X POST "https://docs.google.com/forms/d/e/1FAIpQLSchglVNdUfC_titEV191XeR_uH9NnVYyMMmtuoZmgM0oH3yVg/formResponse" \
            -d "entry.29631913=solar_on" \
            --fail --silent --show-error

      - name: à¸ªà¹ˆà¸‡ solar_off à¹„à¸› Sheet 3
        if: steps.check_mode.outputs.send_solar_off == 'true'
        run: |
          curl -X POST "https://docs.google.com/forms/d/e/1FAIpQLSfR4GihZk5nhFnJndejNVNji_5Mywbg3PIgZi3m3ZjQxGApQQ/formResponse" \
            -d "entry.1012650439=solar_off" \
            --fail --silent --show-error

      - name: à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸–à¸²à¸™à¸°à¹ƒà¸«à¸¡à¹ˆ
        env:
          NEW_MODE: ${{ steps.check_mode.outputs.mode }}
          SEND_SOLAR_ON: ${{ steps.check_mode.outputs.send_solar_on }}
          SEND_SOLAR_OFF: ${{ steps.check_mode.outputs.send_solar_off }}
          SOLAR_ON_SENT_OLD: ${{ steps.read_state.outputs.solar_on_sent }}
          SOLAR_OFF_SENT_OLD: ${{ steps.read_state.outputs.solar_off_sent }}
          SOC: ${{ github.event.client_payload.soc }}
        run: |
          if [ "$SEND_SOLAR_ON" = "true" ]; then
            SOLAR_ON_SENT="true"
            SOLAR_OFF_SENT="false"
          elif [ "$SEND_SOLAR_OFF" = "true" ]; then
            SOLAR_ON_SENT="false"
            SOLAR_OFF_SENT="true"
          else
            SOLAR_ON_SENT="$SOLAR_ON_SENT_OLD"
            SOLAR_OFF_SENT="$SOLAR_OFF_SENT_OLD"
          fi

          echo "mode=$NEW_MODE" > solar_state.txt
          echo "solar_on_sent=$SOLAR_ON_SENT" >> solar_state.txt
          echo "solar_off_sent=$SOLAR_OFF_SENT" >> solar_state.txt
          echo "last_soc=$SOC" >> solar_state.txt
          echo "ðŸ“„ State saved: mode=$NEW_MODE, solar_on_sent=$SOLAR_ON_SENT, solar_off_sent=$SOLAR_OFF_SENT, last_soc=$SOC"

      - name: Commit state changes
        env:
          SOC: ${{ github.event.client_payload.soc }}
          MODE: ${{ steps.check_mode.outputs.mode }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add solar_state.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "Update state: mode=$MODE, SOC=$SOC"
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}
          git push
          echo "âœ… State committed and pushed"
