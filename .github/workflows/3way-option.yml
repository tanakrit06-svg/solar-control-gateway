name: 3-way-option

on:
  repository_dispatch:
    types: [log_event, solar_on, solar_off]

jobs:
  handle_event:
    runs-on: ubuntu-latest
    steps:
      # ‚úÖ Checkout repo ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ credentials (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ PAT manual)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      # üìñ ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå solar_state.txt
      - name: ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        id: read_state
        run: |
          if [ -f solar_state.txt ]; then
            ON_STATE=$(grep '^on=' solar_state.txt | cut -d '=' -f2)
            OFF_STATE=$(grep '^off=' solar_state.txt | cut -d '=' -f2)
          else
            ON_STATE="none"
            OFF_STATE="none"
          fi
          echo "on_state=$ON_STATE" >> $GITHUB_OUTPUT
          echo "off_state=$OFF_STATE" >> $GITHUB_OUTPUT
          echo "Current state: on=$ON_STATE, off=$OFF_STATE"

      # üìù ‡∏™‡πà‡∏á log_event ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      - name: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheet 1 (log)
        if: github.event.action == 'log_event'
        run: |
          curl -X POST https://docs.google.com/forms/d/e/1FAIpQLSdrDVFEEkkdZ6k4rdG4OCkTWoek9GBk1Uip-GWWDZR8HCsXkQ/formResponse \
            -d "entry.747932621=${{ github.event.client_payload.soc }}" \
            -d "entry.1561980421=${{ github.event.client_payload.status }}" \
            --fail --silent --show-error
          echo "Log sent to Sheet 1"

      # ‚òÄÔ∏è ‡∏™‡πà‡∏á solar_on ‡∏ñ‡πâ‡∏≤ on_state != sent
      - name: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheet 2 (solar_on)
        if: github.event.action == 'solar_on' && steps.read_state.outputs.on_state != 'sent'
        run: |
          curl -X POST https://docs.google.com/forms/d/e/1FAIpQLSchglVNdUfC_titEV191XeR_uH9NnVYyMMmtuoZmgM0oH3yVg/formResponse \
            -d "entry.29631913=solar_on" \
            --fail --silent --show-error
          echo "on=sent" > solar_state.txt
          echo "off=none" >> solar_state.txt
          echo "Solar ON sent ‚Üí reset OFF state"

      # üåë ‡∏™‡πà‡∏á solar_off ‡∏ñ‡πâ‡∏≤ off_state != sent
      - name: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheet 3 (solar_off)
        if: github.event.action == 'solar_off' && steps.read_state.outputs.off_state != 'sent'
        run: |
          curl -X POST https://docs.google.com/forms/d/e/1FAIpQLSfR4GihZk5nhFnJndejNVNji_5Mywbg3PIgZi3m3ZjQxGApQQ/formResponse \
            -d "entry.1012650439=solar_off" \
            --fail --silent --show-error
          echo "off=sent" > solar_state.txt
          echo "on=none" >> solar_state.txt
          echo "Solar OFF sent ‚Üí reset ON state"

      # üíæ Commit ‡πÅ‡∏•‡∏∞ push ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ repo ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ PAT
      - name: Commit state changes
        if: github.event.action == 'solar_on' || github.event.action == 'solar_off'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add solar_state.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "Update solar state: ${{ github.event.action }}"
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}
          git push
